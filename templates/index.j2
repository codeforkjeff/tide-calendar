<!DOCTYPE html>
<html lang="en">
<head>
  <title>Tide Calendar</title>
  <style>
    .col-label {
      width: 250px;
      text-align: right;
      padding: 0 1em 1em 1em;
    }
    #form {
      margin-bottom: 2em;
    }
    .month-container {
      margin-bottom: 1em;
    }
  </style>
  <script src="/static/js-year-calendar.min.js"></script>
  <link rel='stylesheet' href='/static/js-year-calendar.min.css'>

  <link rel="stylesheet" href="https://code.jquery.com/ui/1.14.1/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
  <script src="https://code.jquery.com/ui/1.14.1/jquery-ui.js"></script>
  <script>
  (function () {

    const loadTides = async () => {
      const url = "/api/tides" + window.location.search;
      try {
        const response = await fetch(url);
        if (!response.ok) {
          alert(`Response status: ${response.status}`);
        }
        const result = await response.json();

        const container = document.getElementById("table");

        // result['tides'].forEach(record => {
        //   container.insertAdjacentHTML("beforeend", `<div>${new Date(record.tide * 1000)} ${record.prediction}ft</div>`);
        // })

        renderCalendar(result['tides'])

        //console.log(result);
      } catch (error) {
        alert(error.message);
      }
    }

    const getColor = (prediction) => {
      if(prediction < -4) {
        return "#8b0000";
      } else if (prediction < -2) {
        return "#cd5c5c";
      } else {
        return "#ffa07a";
      }
    };

    const formatTime = (date) => {
      const _hours = date.getHours();
      const hours = _hours > 12 ? _hours - 12 : _hours;
      const ampm = _hours > 12 ? "pm" : "am";
      const minutes = ('00' + date.getMinutes()).slice(-2);
      return `${hours}:${minutes}${ampm}`;
    };

    const renderCalendar = async(data) => {

      const dataSource = data.map(record => {
        const date = new Date(record.tide * 1000);
        const sunrise = new Date(record.daylight.sunrise * 1000);
        const sunset = new Date(record.daylight.sunset * 1000);
        return {
          name: `${formatTime(date)} ${record.prediction} ft<br/>Daylight: ${formatTime(sunrise)} - ${formatTime(sunset)}`,
          color: getColor(record.prediction),
          startDate: date,
          endDate: date,
        };
      })

      const year = new Date(data[0].tide * 1000).getFullYear();
      console.log(year);

      const calendar = new Calendar('#calendar', {
        minDate: new Date(year, 0, 1),
        maxDate: new Date(year, 11, 31),
        startYear: year,
        mouseOnDay: function(e) {
          if(e.events.length > 0) {
            var content = '';
            for(var i in e.events) {
              content += e.events[i].name;
            }
            // e.element is a TD element
            $(e.element).tooltip({ content: content, items: ".day" });
            $(e.element).tooltip("open");
          }
        },
        mouseOutDay: function(e) {
            if(e.events.length > 0) {
              $(e.element).tooltip('close');
            }
        },
        dataSource: dataSource,
      });
    };

    document.addEventListener("DOMContentLoaded", (event) => {
      loadTides();
    });
  })();
  </script>
</head>
<body>
  <h1>Tide Calendar</h1>

  <form id="form">
    <div style="display: flex">
      <div class="col-label">
        Place:
      </div>
      <div>
        <select name="place">
          <option value="seattle" {% if request.args["place"] == "seattle" %}selected{% endif %}>Seattle, WA</option>
          <option value="cannon_beach" {% if request.args["place"] == "cannon_beach" %}selected{% endif %}>Cannon Beach, OR</option>
        </select>
      </div>
    </div>
    <div style="display: flex">
      <div class="col-label">
        Year:
      </div>
      <div>
        <select name="year">
          <option value="2025" {% if request.args["year"] == "2025" %}selected{% endif %}>2025</option>
          <option value="2026" {% if request.args["year"] == "2026" %}selected{% endif %}>2026</option>
        </select>
      </div>
    </div>
    <div style="display: flex">
      <div class="col-label">
        Tide Type:
      </div>
      <div>
        <select name="tide_type">
          {% for tide_type_item in tide_type %}
            <option value="{{ tide_type_item.value }}" {% if request.args["tide_type"] == tide_type_item.value %}selected{% endif %} >{{ tide_type_item.value }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    <div style="display: flex">
      <div class="col-label">
        Tide height limit (ft):
      </div>
      <div>
        <input type="text" name="prediction_limit" size="5" value="{{ request.args.get("prediction_limit", 0) }}">
      </div>
    </div>
    <div style="display: flex">
      <div class="col-label">
        Show tides during:
      </div>
      <div>
        <select name="hours_filter">
          <option value="day" {% if request.args["hours_filter"] == "day" %}selected{% endif %}>daylight hours</option>
          <option value="day_1" {% if request.args["hours_filter"] == "day_1" %}selected{% endif %}>daylight +/- 1 hour</option>
          <option value="night" {% if request.args["hours_filter"] == "night" %}selected{% endif %}>nighttime hours</option>
        </select>
        <select name="day_filter">
          <option value="any" {% if request.args["day_filter"] == "any" %}selected{% endif %}>any day of week</option>
          <option value="weekend" {% if request.args["day_filter"] == "weekend" %}selected{% endif %}>weekends only</option>
          <option value="weekday" {% if request.args["day_filter"] == "weekday" %}selected{% endif %}>weekdays only</option>
        </select>
      </div>
    </div>
    <div style="display: flex">
      <div class="col-label"></div>
      <div>
        <input type="submit" value="Update">
      </div>
    </div>
  </form>

  <div id="calendar">
    <div>Loading, hang on...</div>
  </div>

  <div id="table">
  </div>

</body>
</html>
